<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Mafia</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
    <script src="/js/search.js" defer></script>
</head>
<body>
    <div class="container mt-4">
        <div class="sticky-header">
            <div class="container">
                <form action="/search" method="get" class="search-bar">
                    <input
                        type="text"
                        name="q"
                        id="searchInput"
                        class="form-control me-2"
                        placeholder="Search for a movie..."
                        required
                    />
                </form>
            </div>
        </div>

        <a href="/" class="btn btn-secondary">Reset Search</a>

        <h1 class="text-center mb-4">Popular Movies</h1>
        
        <form action="/" method="get" class="mb-4">
            <input type="hidden" name="sort" value="<%= sortBy %>" /> 
            <div class="input-group">
                <label class="input-group-text" for="genre">Filter by Genre:</label>
                <select class="form-select" name="genre" id="genre" onchange="this.form.submit()">
                    <option value="" <% if (!selectedGenre) { %>selected<% } %>>All Genres</option>
                    <% genres.forEach(genre => { %>
                        <option value="<%= genre.id %>" <% if (selectedGenre == genre.id) { %>selected<% } %>>
                            <%= genre.name %>
                        </option>
                    <% }) %>
                </select>
            </div>
        </form>

        <div class="mb-4">
            <% if (selectedGenre) { %>
                <% const genreName = genres.find(g => g.id == selectedGenre)?.name || "Unknown Genre"; %>
                <h2 class="text-center">Showing Movies in Genre: <strong><%= genreName %></strong></h2>
            <% } else { %>
                <h2 class="text-center">Showing Movies in <strong>All Genres</strong></h2>
            <% } %>
        </div>

        <div id="movieResults"></div>
        <form action="/" method="get" class="mb-4">
          <input type="hidden" name="genre" value="<%= selectedGenre %>" />
            <div class="input-group">
                <label class="input-group-text" for="sort">Sort by:</label>
                <select class="form-select" name="sort" id="sort" onchange="this.form.submit()">
                    <option value="popularity.desc" <% if (sortBy === 'popularity.desc') { %>selected<% } %>>Popularity (High to Low)</option>
                    <option value="popularity.asc" <% if (sortBy === 'popularity.asc') { %>selected<% } %>>Popularity (Low to High)</option>
                    <option value="release_date.desc" <% if (sortBy === 'release_date.desc') { %>selected<% } %>>Release Date (Newest)</option>
                    <option value="release_date.asc" <% if (sortBy === 'release_date.asc') { %>selected<% } %>>Release Date (Oldest)</option>
                    <option value="vote_average.desc" <% if (sortBy === 'vote_average.desc') { %>selected<% } %>>Rating (High to Low)</option>
                    <option value="vote_average.asc" <% if (sortBy === 'vote_average.asc') { %>selected<% } %>>Rating (Low to High)</option>
                </select>
            </div>
        </form>
        
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4">
            <% movies.forEach(movie => { %>
                <div class="col mb-4">
                    <div class="card">
                        <img
                            src="https://image.tmdb.org/t/p/w500<%= movie.poster_path %>"
                            class="card-img-top"
                            alt="<%= movie.title %>"
                        />
                        <div class="card-body">
                            <h5 class="card-title"><%= movie.title %></h5>
                            <p class="card-text">
                                <%= movie.overview.substring(0, 150) %>...
                            </p>
                            <a href="/movie/<%= movie.id %>" class="btn btn-primary">
                                Details
                            </a>
                        </div>
                    </div>
                </div>
            <% }) %>
        </div>
        
        <div class="pagination-container text-center">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
            <% if (currentPage > 1) { %>
                <li class="page-item">
                <a 
                    class="page-link" 
                    href="/?genre=<%= selectedGenre %>&sort=<%= sortBy %>&page=<%= currentPage - 1 %>">
                    Previous
                </a>
                </li>
            <% } %>

            <% 
                let startPage = Math.max(1, currentPage - 2); 
                let endPage = Math.min(totalPages, currentPage + 2); 

                for (let i = startPage; i <= endPage; i++) { 
            %>
                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                <a 
                    class="page-link" 
                    href="/?genre=<%= selectedGenre %>&sort=<%= sortBy %>&page=<%= i %>">
                    <%= i %>
                </a>
                </li>
            <% } %>

            <% if (currentPage < totalPages) { %>
                <li class="page-item">
                <a 
                    class="page-link" 
                    href="/?genre=<%= selectedGenre %>&sort=<%= sortBy %>&page=<%= currentPage + 1 %>">
                    Next
                </a>
                </li>
            <% } %>
            </ul>
        </nav>
        </div>
    </div>
</body>
</html>
